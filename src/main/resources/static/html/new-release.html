<!DOCTYPE html>
<html lang="zh_cn">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GitLab Release 版本服务</title>
    <link rel="stylesheet" href="../lib/zui/css/zui.min.css" />
    <link rel="stylesheet" href="../lib/zui/lib/uploader/zui.uploader.min.css" />
    <link rel="stylesheet" href="../lib/zui/css/doc.min.css" />
    <link rel="stylesheet" href="../css/index.css" />
</head>

<body>

<header id="header" class="bg-primary">
    <div class="navbar navbar-inverse navbar-fixed-top" id="navbar" role="banner">
        <div class="container">
            <div class="navbar-header">
                <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".zui-navbar-collapse">
                    <span class="sr-only">切换导航</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a href="/" class="navbar-brand"><span class="path-zui-36"><i class="path-1"></i><i class="path-2"></i></span> <span class="brand-title">ZUI</span> &nbsp;<small class="format-pkg zui-version" data-fmt-text="{version}"></small> <i data-toggle="tooltip" id="compactTogger" data-placement="bottom" class="icon icon-home"></i></a>
            </div>
            <nav class="collapse navbar-collapse zui-navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li id="navDownloadLink"><a title="立即下载" class="format-pkg" data-fmt-href="docs/download/zui-{version}-dist.zip" target="_blank"><i class="icon icon-download-alt"></i><span> 立即下载</span></a></li>
                    <li><a title="了解禅道项目" href="http://zui.5upm.com/product-browse-2.html" target="_blank"><i class="icon icon-lightbulb"></i><span> 项目</span></a></li>
                    <li><a title="论坛" href="http://forum.zui.sexy/forum/" target="_blank"><i class="icon icon-comments-alt"></i><span> 论坛</span></a></li>
                    <li><a title="在Github上Star项目" href="https://github.com/easysoft/zui" target="_blank"><i class="icon icon-github"></i><span> Star</span></a></li>
                </ul>
            </nav>
        </div>
    </div>
</header>

<div class="container">
    <fieldset>
        <legend>项目信息</legend>
        <form id="project-form" class="form-horizontal">
            <div class="form-group">
                <label for="gitlabUrl" class="required col-sm-2">GitLab 地址</label>
                <div class="col-sm-3">
                    <input type="text" class="form-control" id="gitlabUrl" value="https://gitlab.com" placeholder="如：https://gitlab.com">
                </div>
                <label for="token" class="required col-sm-2">访问令牌</label>
                <div class="col-sm-3">
                    <input type="text" class="form-control" id="token" placeholder="可通过 API 访问的令牌（token）">
                </div>
            </div>
            <div class="form-group">
                <label for="projectId" class="required col-sm-2">项目ID</label>
                <div class="col-sm-3">
                    <input type="text" class="form-control" id="projectId" placeholder="请正确填写 GitLab 的项目 ID">
                </div>
            </div>
        </form>
    </fieldset>
    <fieldset>
        <legend>版本信息</legend>
        <form id="release-form" class="form-horizontal">
            <div class="form-group">
                <label for="name" class="required col-sm-2">版本标题</label>
                <div class="col-sm-3">
                    <input type="text" class="form-control" id="name" placeholder="如：v1.2.0重大版本更新">
                </div>
                <label for="tagName" class="required col-sm-2">标签名称</label>
                <div class="col-sm-3">
                    <input type="text" class="form-control" id="tagName" placeholder="发布版本的标签，如：v1.2.0">
                </div>
            </div>
            <div class="form-group">
                <label for="ref" class="col-sm-2">引用标记</label>
                <div class="col-sm-3">
                    <input type="text" class="form-control" id="ref" placeholder="可填写 commit SHA、标签名称或分支名称">
                </div>
                <div class="ref-help help-block">如果标签名称在 GitLab 仓库中不存在，则必须填写该值。
                    更多介绍请<a href="https://gitlab.com/help/api/releases/index.md#create-a-release" target="_blank">参考这里</a>。</div>
            </div>
            <div class="form-group">
                <label for="description" class="required col-sm-2">版本描述</label>
                <div class="col-sm-8">
                    <textarea id="description" rows="8" class="form-control" placeholder="请填写 Markdown 格式的版本描述信息。"></textarea>
                </div>
            </div>
            <div class="form-group">
                <label for="assetsUploader" class="col-sm-2">上传资源</label>
                <div class="col-sm-8">
                    <div id="assetsUploader" class="uploader">
                        <div class="uploader-message text-center">
                            <div class="content"></div>
                            <button type="button" class="close">×</button>
                        </div>
                        <table class="table table-bordered">
                            <thead>
                            <tr>
                                <th colspan="2">文件名</th>
                                <th style="width: 100px">大小</th>
                                <th style="width: 160px; text-align: center;">状态/操作</th>
                            </tr>
                            </thead>
                            <tbody class="uploader-files">
                            <tr class="file template">
                                <td style="width: 38px; padding: 3px"><div class="file-icon"></div></td>
                                <td style="padding: 0">
                                    <div style="position: relative; padding: 8px;">
                                        <strong class="file-name"></strong>
                                        <div class="file-progress-bar"></div>
                                    </div>
                                </td>
                                <td><span class="file-size text-muted"></span></td>
                                <td class="actions text-right" style="padding: 0 4px;">
                                    <div class="file-status" data-toggle="tooltip" style="margin: 8px;"><i class="icon"></i> <span class="text"></span></div>
                                    <a data-toggle="tooltip" class="btn btn-link btn-download-file" target="_blank"><i class="icon icon-download-alt"></i></a>
                                    <button type="button" data-toggle="tooltip" class="btn btn-link btn-reset-file" title="Repeat"><i class="icon icon-repeat"></i></button>
                                    <button type="button" data-toggle="tooltip" class="btn btn-link btn-rename-file" title="Rename"><i class="icon icon-pencil"></i></button>
                                    <button type="button" data-toggle="tooltip" title="Remove" class="btn btn-link btn-delete-file"><i class="icon icon-trash text-danger"></i></button>
                                </td>
                            </tr>
                            </tbody>
                            <tfoot>
                            <tr>
                                <td colspan="4" style="padding: 4px 0">
                                    <div style="position: relative;">
                                        <div class="uploader-status pull-right text-muted" style="margin-top: 5px;"></div>
                                        <button type="button" class="btn btn-link uploader-btn-browse"><i class="icon icon-plus"></i> 选择文件</button>
                                        <button type="button" class="btn btn-link uploader-btn-start"><i class="icon icon-cloud-upload"></i> 开始上传</button>
                                    </div>
                                </td>
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </form>
    </fieldset>
    <div class="form-group">
        <div class="col-sm-offset-2 col-sm-8">
            <div id="form-tip" class="alert alert-warning hide">...</div>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-offset-2 col-sm-8">
            <button id="releaseBtn" class="btn btn-primary"><i class="icon icon-hand-up"></i> 发布版本</button>
        </div>
    </div>
</div>

<footer>
    <div class="container">
        <hr>
        <p class="text-muted small">欢迎使用 GitLab Release 版本发布服务。</p>
    </div>
</footer>

<script src="../lib/jquery/jquery-1.11.0.min.js"></script>
<script src="../lib/zui/js/zui.min.js"></script>
<script src="../lib/zui/lib/uploader/zui.uploader.min.js"></script>
<!--<script src="../lib/zui/js/doc.js"></script>-->
<script>
    $(function () {
        // 几大信息的全局变量.
        var gitlabUrl, token, projectId,
            name, tagName, ref, description;
        var uploading = false;

        /**
         * 校验表单填写是否完善.
         *
         * @returns 是否校验通过
         */
        function validForm() {
            // 获取最新的数据.
            gitlabUrl = $('#gitlabUrl').val();
            token = $('#token').val();
            projectId = $('#projectId').val();
            name = $('#name').val();
            tagName = $('#tagName').val();
            ref = $('#ref').val();
            description = $('#description').val();

            // 对重要数据做校验检查.
            var $formTip = $('#form-tip');
            if (!gitlabUrl) {
                $formTip.html('请填写有效的 GitLab 仓库地址，如：https://gitlab.com').removeClass('hide');
                return false;
            }
            if (!token || $.trim(token).length === 0) {
                $formTip.html('请填写正确的 GitLab API 访问令牌（token），如：gDybLx3yrUK_HLp3qPjS').removeClass('hide');
                return false;
            }
            if (!projectId) {
                $formTip.html('请填写 GitLab 项目仓库的 ID，如：253').removeClass('hide');
                return false;
            }
            if (!name) {
                $formTip.html('请填写本次发布的版本标题，如："v1.2.0重大版本更新"').removeClass('hide');
                return false;
            }
            if (!tagName) {
                $formTip.html('请填写本次发布的标签名称，如：v1.2.0').removeClass('hide');
                return false;
            }
            if (!description) {
                $formTip.html('请使用 Markdown 语法格式来填写版本描述信息。').removeClass('hide');
                return false;
            }

            $formTip.html('').addClass('hide');
            return true;
        }

        // 发布版本的按钮事件.
        $('#releaseBtn').on('click', function () {
            // 校验表单
            if (!validForm()) {
                return;
            }

            // 判断是否正在上传.
            if (uploading) {
                alert('文件正在上传中，请稍后提交!');
                return;
            }

            // 发起 ajax 请求.
            var params = {
                gitlabUrl: gitlabUrl,
                token: token,
                projectId: projectId,
                name: name,
                tagName: tagName,
                ref: ref,
                description: description
            };
            $.ajax({
                type: 'POST',
                url: 'http://127.0.0.1:5050/release',
                contentType:'application/json;charset=utf-8',
                dataType: 'json',
                data: JSON.stringify(params),
                success: function(result) {
                    console.log('成功.');
                },
                error: function() {
                    console.log('失败！');
                }
            });
        });

        // 上传资源文件的相关代码.
        $('#assetsUploader').uploader({
            url: 'http://127.0.0.1:5050/upload/assets',
            onUploadFile: function (file) {
                alert('开始上传');
                uploading = true;
            },
            onFileUploaded: function(file, responseObject) {
                console.log('上传完了一个文件.');
                console.log(file);
            },
            onUploadComplete: function (files) {
                console.log('所有文件上传完毕!');
                uploading = false;
            },
            onError: function () {
                alert('上传出错！');
            }
        });
    });
</script>
</body>
</html>